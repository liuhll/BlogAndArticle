# 依赖注入

ASP.NET Core 应用程序可以利用内置的框架服务将它们注入到启动类的方法中，并且应用程序服务能够配置注入。由 ASP.NET Core 提供的**默认服务容器**提供了最小功能集并且**不是要取代其他容器**。


## 什么是依赖注入

**依赖注入(Dependency injection)，DI**是一种实现**对象**及**其合作者**或**依赖项**之间**松散耦合**的技术
- 使用 `DI` 思想，它们耦合更加松散，因为它们没有对它们的合作者直接硬编码的依赖
- 遵循 **依赖倒置原则（Dependency Inversion Principle）**
  - 高层模块不应该依赖于低层模块；两者都应该**依赖于抽象**
  - 类要求在它们构造时向其提供抽象（通常是 `interfaces` ），而**不是引用特定的实现**

### 构造函数注入（constructor injection）
类会通过它们的**构造函数声明其依赖关系**，允许它们遵循 显示**依赖原则 (Explicit Dependencies Principle)**

### 属性注入

### 容器（containers）
使用 `DI`时 ，很多类通过它们的构造函数（或属性）请求其**依赖关系**，**有一个类**被用来创建这些类及其相关的依赖关系是很有帮助的
- **容器本质：**是一个**工厂**，负责提供向它请求的类型**实例**
- 容器的作用：
  1. 创建管理对象之间的依赖
    > 如果一个给定类型声明它**具有依赖关系**，并且容器已经**被配置为提供依赖类型**，它将把创建依赖关系作为创建请求实例的一部分，不需要任何硬编码的类型构造
  2. 管理应用程序中对象的生命周期

 - ASP.NET Core 包含了一个默认支持构造函数注入的**简单内置容器** （`IServiceProvider`）
   - ASP.NET 的容器指的是它管理的类型为 `services`

### Service   
- `services` 是指由 ASP.NET Core 的 `IoC容器`管理的类型

## 使用框架提供的服务
`Startup` 类的 `ConfigureServices 方法`负责定义应用程序将使用的服务
- 使用一些扩展方法（如 `AddDbContext`，`AddIdentity` 和 `AddMvc` ）向容器中**添加额外服务**

## 注册自己的服务
每个 `services.Add<service>` 调用添加（和可能配置）服务。
> 例如：`services.AddMvc()` 添加 MVC 需要的服务。

## 服务的生命周期（lifetime）
- 为你注册的每一个服务选择**合适的生命周期**是重要的

依赖注入用于的链式方法并不少见，每个请求依次请求它的**依赖关系**。
容器负责解析所有的依赖关系，并返回完全解析后的服务
- 对象图（object graph）
  - 创建请求对象，和它需要的所有对象，以及那些需要的**所有对象**
- 依赖树（dependency tree） | 依赖图（dependency graph）
  - 必须解析依赖关系的集合

### 服务生命周期和注册选项
1. 瞬时
   - **瞬时（Transient）** 生命周期服务在它们**每次请求时被创建**。
   这一生命周期适合轻量级的，**无状态的服务**。  
2. 作用域
   - **作用域（Scoped）**生命周期服务在每次请求被创建一次。  

3. 单例
   - **单例（Singleton）**生命周期服务在它们第一次被请求时创建（或者如果你在 `ConfigureServices`
运行时指定一个实例）并且**每个后续请求将使用相同的实例**

- 服务可以用多种方式在容器中注册   

## 请求服务
来自 `HttpContext` 的一次 ASP.NET 请求中可用的服务通过 `RequestServices` 集合公开的
- **不应该**直接使用这些属性，而更倾向于通过类的构造函数请求需要的类的类型，并且让框架来注入依赖关系

## 如何设计依赖注入服务