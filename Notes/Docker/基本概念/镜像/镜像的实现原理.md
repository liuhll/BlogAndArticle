# Docker镜像实现的原理


- [深入分析Docker镜像原理](http://www.csdn.net/article/2015-08-21/2825511)

- Docker有两方面的技术非常重要
   1. 第一是`Linux 容器`方面的技术
   2. 第二是`Docker镜像`的技术


- `Docker` 镜像是怎么实现增量的修改和维护的？ 
   - 每个镜像都由很多层次构成，`Docker` 使用 `Union FS` 将这些不同的层结合到一个镜像中去

## Union FS 有两个用途
1. 可以实现**不借助** `LVM`、`RAID` 将**多个** `disk` 挂到同一个目录下
2. 另一个更常用的就是将一个只读的分支和一个可写的分支联合在一起，`Live CD` 正是基于此方法可以允许在**镜像不变的基础上**允许用户在其上进行一些**写操作**

> `Docker` 在 `AUFS` 上构建的容器也是利用了类似的原理   


## Docker镜像的内容
- Docker镜像的内容主要包含**两个部分**
  1. `镜像层`文件内容；
  2. 镜像`json`文件

- 对`Docker镜像`内容认识的变化

   1. *第一阶段*：初步接触Docker。
        - 相信很多爱好者都会和我一样，有这样一个认识：`Docker镜像`代表一个**容器的文件系统内容**；

   2. *第二阶段*：初步接触联合文件系统。
        - 联合文件系统的概念，让我意识到镜像层级管理的技术，每一层镜像都是容器文件系统内容的一部分。

   3. *第三阶段*：研究镜像与容器的关系：
        - `容器`是一个**动态的环境**，每一层镜像中的文件属于**静态内容**
        - 然而 `Dockerfile` 中的 `ENV`、`VOLUME`、`CMD` 等内容最终都需要落实到容器的运行环境中，而这些内容均**不可能**直接坐落到每一层镜像所包含的文件系统内容中，那此时每一个`Docker镜像`还会包含 `json文件`记录与容器之间的关系。


## Docker镜像存储位置
### 查看镜像层组成
- 命令 
```bash
$ docker history image_name:tag        
```
 ![docker镜像层组成](http://img.ptcms.csdn.net/article/201508/21/55d6b1fa0ffa1.jpg)

### 镜像层文件内容存储
- `Docker镜像层`的内容一般在 `Docker根目录`的 `aufs` 路径下
   -  `/var/lib/docker/aufs/diff/`

   - ![镜像层文件内容存储](http://img.ptcms.csdn.net/article/201508/21/55d6b29e80853.jpg)
   > **Notes**
   > - 图中显示了镜像 `ubuntu:14.04` 的 `4个镜像层`内容，以及每个镜像层内的一级目录情况。
   > - 需要额外注意的是：镜像层 d2a0ecffe6fa 中没有任何内容，也就是所谓的空镜像

### 镜像 json 文件存储
- 对于每一个`镜像层`，`Docker` 都会保存一份相应的 `json` 文件，
   - `json` 文件的存储路径为 `/var/lib/docker/graph`   
   - ![镜像 json 文件存储](http://img.ptcms.csdn.net/article/201508/21/55d6b3047073a.jpg)
   - 每一个`镜像层`还包含一个 `layersize` 文件，该文件主要记录镜像层内部文件内容的**总大小**
