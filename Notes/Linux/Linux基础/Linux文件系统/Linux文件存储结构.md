# Linux文件存储结构，包括目录项、inode、数据块

大部分的Linux文件系统（如`ext2`、`ext3`）规定，一个文件由`目录项`、`inode`和`数据块`组成

- **目录项**：包括`文件名`和`inode`节点号。
- **Inode**：又称`文件索引节点`，
    - 包含**文件的基础信息**
    - 以及**数据块的指针**。
- **数据块**：包含文件的**具体内容**。

## inode
`文件`储存在硬盘上，硬盘的最小存储单位叫做`扇区`（`Sector`），每个`扇区`储存512字节（相当于0.5KB）

- 操作系统读取硬盘的时候，不会一个扇区一个扇区地读取，这样*效率太低*，
   - 而是一次性连续读取多个扇区, 一次性读取一个`块`（`block`）

- `块`
  - 由多个扇区组成的`块`，是*文件存取的最小单位*
  - `块`的大小，最常见的是*4KB*，即连续八个 `sector`组成一个 `block` 

- **文件数据**都储存在`块`中，那么很显然，我们还必须找到一个地方储存`文件的元信息`  

- `文件的元信息`
  - 文件的创建者、
  - 文件的创建日期、
  - 文件的大小
  - ...

> **定义**  
> 这种储存文件元信息的区域就叫做`inode`，中文译名为`索引节点`  

- `inode`包含文件的元信息
  - 文件的**字节数**。
  - 文件拥有者的`User ID`。
  - 文件的`Group ID`。
  - 文件的`读`、`写`、`执行`权限。
  - 文件的时间戳，共有三个：
     1. `ctime`指`inode`上一次变动的时间，
     2. `mtime`指文件内容上一次变动的时间，
     3. `atime`指文件上一次打开的时间。
  - `链接数`，即有多少文件名指向这个`inode`。
  - 文件数据`block`的位置。
 
  > **Notes**  
  > 除了`文件名`以外的所有文件信息，都存在`inode`之中。

- 用`stat`命令，查看某个文件的`inode`信息

```
stat demo.txt
```

- 当查看某个文件时，会先从`inode`表中查出文件属性及数据存放点，再从数据块中读取数据

- 文件存储结构示意图
   ![文件存储结构示意图](http://c.biancheng.net/cpp/uploads/allimg/140901/1-140Z11I213549.png)


### inode的大小

- `inode`也会消耗硬盘空间，所以硬盘格式化的时候，操作系统自动将硬盘分成**两个区域**
   1. 一个是`数据区`，存放文件数据；
   2. 另一个是`inode区`（`inode table`），存放`inode`所包含的信息  

- 每个`inode`节点的大小，一般是*128字节*或*256字节*    
- `inode`节点的总数，在格式化时就给定，一般是每`1KB`或每`2KB`就设置一个`inode`
    > **Notes**  
    > 在一块1GB的硬盘中，每个`inode`节点的大小为`128`字节，每`1KB`就设置一个`inode`，那么`inode table`的大小就会达到`128MB`，占整块硬盘的`12.8%`

- 查看每个硬盘分区的`inode`总数和已经使用的数量，可以使用`df -i` 命令

- 查看每个`inode`节点的大小，可以用如下命令：
```
$ sudo dumpe2fs -h /dev/hda | grep "Inode size"
```

> **Notes**  
> 由于每个文件都必须有一个`inode`，因此有可能发生`inode`已经用光，但是硬盘还未存满的情况。这时，*就无法在硬盘上创建新文件*

### inode号码
- 每个`inode`都**有一个号码**，操作系统用`inode号码`来识别不同的文件

- Linux系统*内部不使用文件名*，而使用`inode号码`来识别文件。
   - 对于系统来说，`文件名`只是`inode号码`便于识别的别称或者绰号。

- 系统打开的文件过程
    1. 首先，系统找到这个文件名对应的`inode号码`；
    2. 其次，通过`inode号码`，获取`inode信息`；
    3. 最后，根据`inode信息`，找到文件数据所在的`block`，读出数据。
   
- 使用`ls -i`命令，可以看到文件名对应的`inode号码`   

```
ls -i demo.txt
```

## 目录项
- Linux系统中，`目录`（`directory`）也是一种`文件`。
    - 打开`目录`，实际上就是打开`目录文件`。

### 目录文件
- 结构非常简单，就是一系列`目录项`（`dirent`）的列表
- 组成 
   - 所包含文件的`文件名`，
   - 以及该文件名对应的`inode号码`    

- `ls命令`只列出目录文件中的所有文件名：
```
ls /etc
```
- `ls -i`命令列出整个`目录文件`，即`文件名`和`inode号码`：
```
ls -i /etc
```
- 如果要查看文件的详细信息，就必须根据`inode号码`，访问`inode节点`，读取信息。`ls -l`命令列出文件的详细信息。
```
ls -l /etc
```

## 硬链接和软链接
### 硬链接（hard link） 
- 一般情况下，`文件名`和`inode号码`是**一一对应**关系，每个`inode号码`对应一个`文件名`
- Linux系统**允许**，*多个文件名*指向同一个`inode号码`
   - 可以用不同的文件名访问同样的内容
   - 对文件内容进行修改，会影响到所有`文件名`
   - 删除一个`文件名`，**不影响**另一个`文件名`的访问
    > 硬链接

- 创建硬链接

```
$ ln source_file target_file
```
- `源文件`与`目标文件`的`inode号码`相同，都指向同一个`inode`
   - `inode`信息中有一项叫做`链接数`，记录指向该`inode`的文件名总数，这时就会增加`1`
   - 删除一个文件名，就会使得`inode节点`中的"链接数"减1

> **Notes**  
> 当这个值减到`0`，表明没有文件名指向这个`inode`，系统就会回收这个`inode号码`，以及其所对应`block区域`

### 目录文件的"链接数"
- 创建`目录`时，默认会生成两个`目录项`：`.`和`..`

   - 前者的`inode号码`就是当前目录的`inode号码`，等同于*当前目录*的`硬链接`；
   - 后者的`inode号码`就是当前目录的*父目录*的`inode号码`，等同于*父目录*的`硬链接`

> **Notes**  
> 任何一个目录的`硬链接`总数，总是等于`2`加上它的子目录总数（含隐藏目录）
> - 这里的`2`是父目录`..`对其的***硬链接**和当前目录下的`.`  **硬链接**   

### 软链接
- `文件A`和`文件B`的`inode号码`虽然不一样，但是`文件A`的内容是`文件B`的**路径**
   - 读取`文件A`时，系统会自动将访问者导向`文件B`。因此，无论打开哪一个文件，最终读取的都是`文件B` 
   > `文件A`就称为`文件B`的`软链接`（`soft link`）或者"`符号链接`（`symbolic link`）
   
- `文件A`依赖于`文件B`而存在，如果删除了`文件B`，打开`文件A`就会报错：*No such file or directory*   
- 软链接与硬链接最大的不同
   - `文件A`指向`文件B`的文件名，而**不是**`文件B`的`inode号码`，`文件B`的`inode` `链接数`不会因此发生变化

- `ln -s`命令可以创建软链接
```
ln -s source_file target_file
```
